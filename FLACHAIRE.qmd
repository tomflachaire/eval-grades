---
title: "eval-grades"
author: "Tom Flachaire"
format: html
---

Here is the link of my github : https://github.com/tomflachaire/eval-grades.git

# 1. Introduction

## 1.1 Study organisation

### Question 1 

```{r}
here::i_am("eval-grades.Rproj")
library(ggplot2)
library(dplyr)
library(readr)
library(knitr)
library(here)
library(lubridate)
library(tidyr)
```

```{r}
courses <- read_csv(here("courses.csv"))
```

### Question 2

```{r}
courses %>%
  arrange(course) %>%  # Tri alphabétique
  rename(
    "course name" = course,
    "identifier" = course_id,
    "module" = module,
    "number of exams" = nb_grades   # colonne réelle de ton fichier
  ) %>%
  kable(caption = "Course description table")
```

## 1.2 Students

### Question 3

```{r}
students <- read_csv(here("students.csv"),
  col_types = cols(
    id = col_integer(),
    group = col_factor(),
    birth_date = col_date(format = ""),
    sex = col_factor()
  )
)

str(students)
```

## 1.3 Grades

### Question 4 

```{r}
grades <- read_delim(here("grades.csv"),
  delim = ";",      
  na = "$",         
  col_types = cols(
    id = col_integer(),
    course_id = col_integer(),
    grade = col_double()
  )
)

str(grades)
```

# 2. Student population analysis

### Question 5 

```{r}
students %>%
  count(group) %>%
  ggplot(aes(x = factor(group), y = n)) +
  geom_col(fill = "steelblue") +
  labs(title = "Number of Students per Group", x = "Group", y = "Students")
```

### Question 6

```{r}
students %>%
  count(group, sex) %>%
  ggplot(aes(x = factor(group), y = n, fill = sex)) +
  geom_col() +
  labs(title = "Gender Balance per Group", x = "Group", y = "Students")
```

### Question 7 

```{r}
students %>%
  mutate(age = round(time_length(today() - birth_date, "year"))) %>%
  ggplot(aes(x = age)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "white") +
  labs(title = "Distribution of Student Ages", x = "Age", y = "Number of Students")
```

### Question 8 

```{r}
students %>%
  mutate(age = round(time_length(today() - birth_date, "year"))) %>%
  group_by(group) %>%
  summarise(median_age = as.integer(median(age))) %>%
  kable(caption = "Median age of students per group")
```

### Question 9 

```{r}
students %>%
  mutate(age = round(time_length(today() - birth_date, "year"))) %>%
  group_by(group) %>%
  slice_max(order_by = age, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  select(id, sex, age, group) %>%
  arrange(desc(age)) %>%
  kable(caption = "Oldest student in each group")
```

# 3. Simple grade analysis

### Question 10 

```{r}
n_grades <- grades %>%
  filter(!is.na(grade)) %>%
  nrow()

cat("The data set contains", n_grades, "grades.") # to display
```

### Question 11

```{r}
grades %>%
  filter(course_id == 7) %>%  # Historical Archaeology and Antiquarian Studies
  left_join(students, by = "id") %>%
  group_by(group) %>%
  summarise(avg_grade = mean(grade, na.rm = TRUE)) %>%
  ggplot(aes(x = factor(group), y = avg_grade)) +
  geom_col(fill = "blue") +
  labs(title = "Average Grade in Historical Archaeology per Group",
       x = "Group", y = "Average Grade")
```

### Question 12 

```{r}
grades %>%
  left_join(courses, by = "course_id") %>%
  ggplot(aes(x = factor(module), y = grade)) +
  geom_boxplot() +
  labs(title = "Grade Distribution by Module",
       x = "Module", y = "Grade")
```

# 4. Attendance analysis

### Question 13

```{r}

# We compute the number of grades per student
grades %>%
  filter(!is.na(grade)) %>%
  group_by(id) %>%
  summarise(n_grades = n()) %>%
  left_join(students, by = "id") %>%
  select(id, group, sex, n_grades) %>%
  slice_head(n = 10) %>%
  kable(caption = "Number of grades per student (first 10 rows)")

# Summary 
grades %>%
  filter(!is.na(grade)) %>%
  group_by(id) %>%
  summarise(n_grades = n()) %>%
  summarise(
    min = min(n_grades),
    max = max(n_grades),
    mean = round(mean(n_grades), 1),
    median = median(n_grades)
  ) %>%
  kable(caption = "Summary of number of grades per student")
```

### Question 14

```{r}
grades %>%
  filter(!is.na(grade)) %>%
  group_by(id) %>%
  summarise(n_grades = n()) %>%
  left_join(students, by = "id") %>%
  ggplot(aes(x = n_grades, fill = sex)) +
  geom_histogram(position = "dodge", binwidth = 1) +
  labs(title = "Distribution of number of grades by sex",
       x = "Grades",
       y = "Students")
```

### Question 15

```{r}
grades %>%
  filter(course_id == 4 & !is.na(grade)) %>% # for alchemy and Chemical Engineering
  group_by(id) %>%
  summarise(n_grades = n()) %>%
  left_join(students, by = "id") %>%
  select(id, group, n_grades) %>%
  slice_head(n = 10) %>%
  kable(caption = "Number of grades in Alchemy and Chemical Engineering (first 10 rows)")
```

### Question 16

```{r}
grades %>%
  filter(course_id == 4 & !is.na(grade)) %>%  
  group_by(id) %>%
  summarise(n_grades = n()) %>%
  count(n_grades) %>%                   
  ggplot(aes(x = n_grades, y = n)) +
  geom_col() +
  labs(title = "Distribution of number of grades in Alchemy and Chemical Engineering",
       x = "Grades",
       y = "Students")
```

### Question 17 

```{r}
grades %>%
  filter(course_id == 4 & !is.na(grade)) %>%
  group_by(id) %>%
  summarise(n_grades = n()) %>%
  left_join(students, by = "id") %>%
  group_by(group) %>%
  summarise(mean_grades = mean(n_grades)) %>%
  ggplot(aes(x = factor(group), y = mean_grades)) +
  geom_col() +
  labs(title = "Average number of grades in Alchemy and Chemical Engineering by Group",
       x = "Group",
       y = "Average Number of Grades")
```

The graph shows that the average number of grades per student is quite similar across all groups, indicating a homogeneous distribution.

### Question 18 

```{r}
grades %>%
  filter(course_id == 4 & !is.na(grade)) %>%
  group_by(id) %>%
  summarise(n_grades = n()) %>%
  left_join(students, by = "id") %>%
  group_by(group, sex) %>%
  summarise(mean_grades = mean(n_grades)) %>%
  ggplot(aes(x = factor(group), y = mean_grades, fill = sex)) +
  geom_col(position = "dodge") +
  labs(title = "Average number of grades in Alchemy and Chemical Engineering by Group and Sex",
       x = "Group",
       y = "Average number of grades",
       fill = "Sex")
```

### Question 19

```{r}
grades_named <- grades %>%
  filter(!is.na(grade)) %>%
  left_join(courses, by = c("course_id")) %>%  # ajouter nom du cours
  group_by(id, course) %>%
  summarise(avg_grade = mean(grade), .groups = "drop") %>%
  left_join(students, by = "id") %>%
  select(id, group, course, avg_grade)

grades_wide <- grades_named %>%
  pivot_wider(names_from = course, values_from = avg_grade)

# We display a small extract
grades_wide %>%
  slice_head(n = 5) %>%
  kable(caption = "Average grades per student (full table has all courses, course names as columns)")
```

### Question 20

```{r}
# Compute average grades per student for the two courses
avg_two_courses <- grades %>%
  filter(!is.na(grade) & course_id %in% c(5, 6)) %>%  # only Electrical Engineering (5) and Cryptography (6)
  group_by(id, course_id) %>%
  summarise(avg_grade = mean(grade), .groups = "drop") %>%
  pivot_wider(names_from = course_id, values_from = avg_grade) %>%
  left_join(students, by = "id") 

# Scatter plot
ggplot(avg_two_courses, aes(x = `6`, y = `5`)) + # with x = Cryptography, y = Electrical Engineering
  geom_point() +                                 
  geom_smooth(method = "lm", se = FALSE, color = "blue") + # trend line
  labs(
    title = "Average Grades: Electrical Engineering vs Cryptography",
    x = "Cryptography and Codebreaking (avg grade)",
    y = "Electrical Engineering and Telegraphy (avg grade)"
  ) +
  theme_minimal()                           
```

### Question 21

```{r}
# Compute average grades per student for the two courses
avg_courses <- grades %>%
  filter(!is.na(grade) & course_id %in% c(2, 10)) %>%  # 2: Airship Piloting, 10: Etiquette
  group_by(id, course_id) %>%
  summarise(avg_grade = mean(grade), .groups = "drop") %>%
  pivot_wider(names_from = course_id, values_from = avg_grade) %>%
  left_join(students, by = "id")  # add group

# correlation per group
cor_by_group <- avg_courses %>%
  group_by(group) %>%
  summarise(correlation = cor(`10`, `2`, use = "complete.obs"))  # 10 = Etiquette, 2 = Airship

cor_by_group %>% 
  kable(caption = "Correlation between Etiquette and Airship by group")
```

### Question 22

```{r}
# we find the group with the highest absolute correlation
target_group <- cor_by_group %>%
  slice_max(abs(correlation)) %>%
  pull(group)

# filter students of that group and plot
avg_courses %>%
  filter(group == target_group) %>%
  ggplot(aes(x = `2`, y = `10`)) +  # x = Airship, y = Etiquette
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(
    title = paste("Airship vs Etiquette grades for group", target_group),
    x = "Airship Piloting and Navigation",
    y = "Etiquette and Social Graces"
  ) +
  theme_minimal()
```

### Question 23

```{r}
# wecompute average grade per student per course
avg_per_course <- grades %>%
  filter(!is.na(grade)) %>%
  group_by(id, course_id) %>%
  summarise(avg_course = mean(grade), .groups = "drop")

# compute final grade = average of the course averages
final_grades <- avg_per_course %>%
  group_by(id) %>%
  summarise(final_grade = mean(avg_course), .groups = "drop") %>%
  left_join(students, by = "id") %>%
  select(id, group, sex, final_grade) %>%
  arrange(desc(final_grade))

# display top 5 students
final_grades %>%
  slice_head(n = 5) %>%
  kable(caption = "First five students by final grade")
```

### Question 24

```{r}
final_grades %>%
  ggplot(aes(x = factor(group), y = final_grade)) +  
  geom_boxplot() +
  labs(
    title = "Distribution of final grades by group",
    x = "Group",
    y = "Final grade"
  ) +
  theme_minimal()
```

### Question 25

```{r}
# boxplot of final grades by group and separated by sex
final_grades %>%
  ggplot(aes(x = factor(group), y = final_grade, fill = sex)) +
  geom_boxplot() +
  labs(
    title = "Final Grades by Group and Sex",
    x = "Group",
    y = "Final Grade",
    fill = "Sex"
  ) +
  theme_minimal()
```
